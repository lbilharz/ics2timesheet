<html lang="de">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

  <title>Stundenzettel</title>
  <script src="ical.js" type="text/javascript" charset="utf-8"></script>
  <script src="timeRangePresets.js" type="text/javascript" charset="utf-8"></script>

  <link type="text/css" href="screen.css" rel="Stylesheet" />
  <script type="text/javascript">

  const jobs = []
  let selectedJobs = [];
  let minAge
  let maxAge
  const now = new Date();
  let ics

  document.addEventListener('DOMContentLoaded', function() {
    minAge = document.querySelector('#minAge');
    maxAge = document.querySelector('#maxAge');
    document.querySelector('#userNameInput').addEventListener('change', function(event) {
      document.querySelector('#userName').innerHTML = event.target.value;
    })
    document.querySelector('#icsFile').addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          ics = e.target.result;
          loadThisMonth()
        }
        reader.readAsText(file);
      }
    })
  })

  function getJSDateFromICSDate(ISODateTime) {
    // Check if the string is in ISO 8601 format (with hyphens and colons)
    if (ISODateTime.includes('-') && ISODateTime.includes('T')) {
      return new Date(ISODateTime);
    }
    const regex = /^(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})/;
    const match = ISODateTime.match(regex);

    if (!match) {
      console.warn('Invalid ICS date format:', ISODateTime);
      return now // Return current date/time if input is invalid
    }

    const [, year, month, day, hour, minute] = match.map(Number);
    return new Date(year, month - 1, day, hour, minute);
  }

  function getNiceDateString(then, short) {
    if (short) return padStart(then.getDate()) +"."+ padStart((then.getMonth()+1))+"."+then.getFullYear();
    return padStart(then.getDate()) +"."+ padStart((then.getMonth()+1))+"."+then.getFullYear() +" "+padStart(then.getHours()) +":"+padStart(then.getMinutes());
  }

  function humanizeDuration(duration) {
    const hours = duration >= 60 ? Math.floor(duration/60) + "' " : ""
    return hours + padStart(duration%60) +"\""
  }

  function padStart(number, targetLength = 2) {
    return String(number).padStart(targetLength, '0');
  }

  function updateSelectedJobs() {
    const checkboxes = document.querySelectorAll('#jobs input[type="checkbox"]:checked');
    selectedJobs = Array.from(checkboxes).map(checkbox => checkbox.value);
  }

  function parseIcs2XML() {
    const jcalData = ICAL.parse(ics);
    const comp = new ICAL.Component(jcalData);
    const calendarName = comp.getFirstPropertyValue("x-wr-calname");
    const vevents = comp.getAllSubcomponents("vevent");
    const jSONEvents = []
    var min = new Date(Date.parse(minAge.value +" 00:00:00"));
    var max = new Date(Date.parse(maxAge.value +" 23:59:59"));
    document.getElementById('from').innerText = getNiceDateString(min, true)
    document.getElementById('until').innerText = getNiceDateString(max, true)
    vevents.forEach(function(vevent) {
      const event = new ICAL.Event(vevent);
      const start = getJSDateFromICSDate(event.startDate.toString());
      const end = getJSDateFromICSDate(event.endDate.toString());
      var duration = (end.getTime()-start.getTime())/1000/60;

      console.log(start, end, duration);
      if (start.getTime()>min.getTime() && start.getTime()<max.getTime()) {
        const summary = event.summary;
        console.log(summary);
        var job = (summary.split('('))[0].trim()
        if (!jobs.includes(job)) jobs.push(job)
        if (!selectedJobs || !selectedJobs.length || selectedJobs.includes(job)) {
          jSONEvents.push({type: 'event', summary, start, end, duration, job})
        }
      }
    })
    jSONEvents.sort((a, b) => {
      return a.start > b.start ? 1 : -1
    })
    printXML(jSONEvents, calendarName);
  }

  function printXML(json, name) {

    var result = "<table><thead><tr><th>What</th><th>When</th><th>Duration</th><th class='sort' >Sort</th></tr></thead><tbody>";
    const title = `– ${name} –`
    const selectedJobList = selectedJobs && selectedJobs.length !== 0 ?" ("+ selectedJobs.join(', ') +")":""
    document.getElementById('calName').innerText = title + selectedJobList
    document.title = document.getElementById('calName').innerText

    let currentDate;
    let dayTotal = 0;
    let total = 0;
    json.forEach(event => {
      const eventDate = formatDate(event.start);
      if (!currentDate) {
        currentDate = eventDate;
      }
      if (currentDate !== eventDate) {
        result += `<tr class="dayTotal"><td colspan="2">${getNiceDateString(new Date(currentDate), true)}</td><td>${humanizeDuration(dayTotal)}</td></tr>`;
        currentDate = eventDate;
        dayTotal = 0; // Reset dayTotal when the day changes
      }
      total += event.duration;
      dayTotal += event.duration;

      result += `<tr><td>${event.summary}</td>`;
      result += `<td>${getNiceDateString(event.start, false)}</td>`;
      result += `<td>${humanizeDuration(event.duration)}</td>`;
      result += `<td class='sort'>${event.start.getTime()}</td></tr>`;
    });

    // Add the last day's total if necessary
    if (dayTotal > 0) {
      result += `<tr class="dayTotal"><td colspan="2">${getNiceDateString(new Date(currentDate), true)}</td><td>${humanizeDuration(dayTotal)}</td></tr>`;
    }

    function formatCurrency(amount) {
      return `${amount.toLocaleString('de-DE', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      })} €`;
    }
    const hourDecimal = (total/60).toFixed(2);
    result += "</tbody><tfoot><tr><th colspan='2'>Total Hours</br /><small>(8h days)</small></th><th>"+ hourDecimal+" Std.<br /><small>("+Math.floor(total/60/8)+"d "+Math.floor((total/60)%8) +"h "+ Math.round(total%60)+"min)</small></th></tr>";
    const hourlyRate = Number.parseInt(document.querySelector('#geld').value, 10)
    if (hourlyRate !== Number.NaN && hourlyRate > 0 ) {
      const net = formatCurrency(hourDecimal * hourlyRate)
      const tax = formatCurrency(hourDecimal * hourlyRate * 0.19)
      const gross = formatCurrency(hourDecimal * hourlyRate * 1.19)
      result += `<tr><th colspan='2'>Net <small>(${hourDecimal} h x ${formatCurrency(hourlyRate)})</small></th><th>${net}</th></tr>`;
      result += `<tr><td colspan='2'>Value added Tax 19%</td><td>${tax}</td></tr>`;
      result += `<tr><th colspan='2'>Gross</th><th>${gross}</th></tr>`;

    }
    result += "</tfoot></table>";
    document.querySelector('#results').innerHTML = result;
    const jobSelection = ["<legend>Jobs</legend>"];
    for (var i=0; i<jobs.length; i++) {
      const checked = selectedJobs && selectedJobs.includes(jobs[i]) ? ' checked="checked"' : '';
      if (i !== 0) jobSelection.push(" - ")
      jobSelection.push(`<span><input name='tasks' type='checkbox'${checked} value='${jobs[i]}'>${jobs[i]}</span>`)
    }
    jobSelection.push("")
    document.querySelector('#jobs').innerHTML = jobSelection.join('')

    document.querySelectorAll('#jobs input[type="checkbox"]').forEach(checkbox => {
      checkbox.addEventListener('click', () => {
        updateSelectedJobs()
        parseIcs2XML()
        return false
      })
    })
  }
  </script>
</head>

<body>
  <form action="">
    <fieldset>
      <legend>Name</legend>
      <label for="userNameInput">Name of the Freelancer: </label><input id="userNameInput" type="text" value="" />
    </fieldset>
    <fieldset>
      <legend>Calendar File </legend>
      <label for="icsFile">Calendar: <small>(.ics)</small></label>
      <input type="file" id="icsFile" accept=".ics">
    </fieldset>
    <fieldset>
      <legend>Configuration</legend>
      <label for="geld">Hourly rate: </label><input id="geld" type="number" value="90" list="defaultRates" onchange="parseIcs2XML()" />
      <datalist id="defaultRates">
        <option value="0">
        <option value="30">
        <option value="60">
        <option value="90">
        <option value="120">
        <option value="150">
        <option value="180">
      </datalist>
      <p>Timeframe: <small>(MM.DD.YYYY)</small></p>
      <label for="minAge">From: </label><input id="minAge" type="date" />
      <label for="maxAge"> until: </label><input id="maxAge" type="date" />
      (including)
      <p>
        <input type="button" value="Last Month" onclick="loadLastMonth()" />
        <input type="button" value="Last Week" onclick="loadLastWeek()" />
        <input type="button" value="Yesterday" onclick="loadYesterday()" />
        <input type="button" value="Today" onclick="loadToday()" />
        <input type="button" value="This Week" onclick="loadThisWeek()" />
        <input type="button" value="This Month" onclick="loadThisMonth()" />
      </p>
    </fieldset>
    <fieldset id='jobs'><legend>Jobs</legend></fieldset>
  </form>
  <h1><span id="userName"></span> <small><br/><span id="calName"></span> <br/><span id="from"></span> – <span id="until"></span></small></h1>
<div id="results"></div>
</body>
</html>
